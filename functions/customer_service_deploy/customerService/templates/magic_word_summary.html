<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Kabir ‚Äì Magic Word Summary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .hidden {
      display: none;
    }

    .magic-word-card {
      cursor: pointer;
      transition: all 0.3s;
    }

    .magic-word-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }

    .badge-status {
      font-size: 0.9rem;
      padding: 0.5rem 0.75rem;
    }

    .detail-section {
      margin-bottom: 2rem;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container py-5">
    <!-- üìã LIST VIEW -->
    <div id="listView" class="hidden">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Magic Word Requests</h1>
        <span id="requestCount" class="badge bg-info">Loading...</span>
      </div>

      <div id="requestsList" class="row g-3">
        <!-- Cards will be injected here -->
      </div>

      <div id="emptyMessage" class="alert alert-info text-center hidden">
        No pending magic word requests found.
      </div>
    </div>

    <!-- üîç DETAIL VIEW -->
    <div id="detailView" class="hidden">
      <div class="d-flex align-items-center justify-content-between mb-4">
        <div class="d-flex align-items-center">
          <button id="backBtn" class="btn btn-outline-secondary me-3">‚Üê Back</button>
          <h1>Magic Word Request Detail</h1>
        </div>

        <!-- ‚úÖ NEW: Toggle Switch for kabirAI / kabirTeam -->
        <div class="d-flex align-items-center gap-3">
          <div class="form-check form-switch" style="transform: scale(1.3); transform-origin: right center;">
            <input class="form-check-input" type="checkbox" id="humanInteractionToggle" onchange="toggleHumanInteraction()">
            <label class="form-check-label" for="humanInteractionToggle" id="toggleLabel">
              kabirAI
            </label>
          </div>
          <span id="toggleStatus" class="badge bg-secondary"></span>
        </div>
      </div>

      <!-- Magic Word Request Info -->
      <div class="detail-section card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">üîÆ Magic Word Request</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Magic Word:</strong> <span id="detail-magicWord" class="badge bg-warning"></span></p>
              <p><strong>Status:</strong> <span id="detail-status" class="badge badge-status"></span></p>
              <p><strong>Matched At:</strong> <span id="detail-matchedAt"></span></p>
            </div>
            <div class="col-md-6">
              <p><strong>Chat ID:</strong> <code id="detail-chatId"></code></p>
              <p><strong>Message ID:</strong> <code id="detail-messageId"></code></p>
              <p><strong>Location:</strong> <span id="detail-location"></span></p>
            </div>
          </div>
          <hr />

          <!-- Status Change Button -->
          <div class="mb-3">
            <button id="statusChangeBtn" class="btn btn-primary" onclick="changeStatus()">
              Next Status
            </button>
            <span id="statusMessage" class="ms-2"></span>
          </div>

          <!-- Chat Context - Last 10 Messages -->
          <p><strong>üí¨ Chat Context (Last 10 Messages):</strong></p>
          <div id="detail-chatContext"
            style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
            <!-- Messages will be injected here -->
          </div>
          <div id="noChatContextMessage" class="alert alert-secondary text-center hidden mt-3">
            No chat context available.
          </div>
        </div>
      </div>

      <!-- User Info -->
      <div class="detail-section card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">üë§ User Details</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>User ID:</strong> <code id="detail-userId"></code></p>
              <p><strong>Name:</strong> <span id="detail-userName"></span></p>
              <p><strong>Email:</strong> <span id="detail-userEmail"></span></p>
            </div>
            <div class="col-md-6">
              <p><strong>Phone:</strong> <span id="detail-userPhone"></span></p>
              <p><strong>Photo:</strong></p>
              <img id="detail-userPhoto" src="" alt="User Photo"
                style="max-width: 100px; max-height: 100px; border-radius: 8px;" />
            </div>
          </div>
        </div>
      </div>

      <!-- User Location Info -->
      <div class="detail-section card">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">üìç User Location</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Location Name:</strong> <span id="detail-locName"></span></p>
              <p><strong>Latitude:</strong> <span id="detail-locLat"></span></p>
              <p><strong>Longitude:</strong> <span id="detail-locLon"></span></p>
            </div>
            <div class="col-md-6">
              <p><strong>Recorded At:</strong> <span id="detail-locRecordedAt"></span></p>
              <p><strong>Map Link:</strong> <a id="detail-mapLink" href="" target="_blank"
                  class="btn btn-sm btn-primary">View on Map</a></p>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚úÖ NEW: Send Message Section -->
      <div class="detail-section card">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">üí¨ Send Message to User</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-12 mb-3">
              <label class="form-label"><strong>Message Type</strong></label>
              <select class="form-control" id="messageType" onchange="handleMessageTypeChange()">
                <option value="">Select message type...</option>
                <option value="custom">Custom Message</option>
                <option value="service_request">Service Request Confirmation</option>
                <option value="booking_confirmation">Booking Confirmation</option>
                <option value="general">General Update</option>
              </select>
            </div>

            <!-- Custom Message Text Area -->
            <div class="col-md-12 mb-3" id="customMessageDiv" style="display: none;">
              <label class="form-label"><strong>Message *</strong></label>
              <textarea class="form-control" id="customMessage" rows="4"
                placeholder="Enter your message here..."></textarea>
            </div>

            <!-- Service Request Message Preview -->
            <div class="col-md-12 mb-3" id="serviceRequestPreviewDiv" style="display: none;">
              <label class="form-label"><strong>Message Preview</strong></label>
              <div class="alert alert-info" id="serviceRequestPreview"></div>
            </div>

            <!-- Booking Confirmation Preview -->
            <div class="col-md-12 mb-3" id="bookingPreviewDiv" style="display: none;">
              <label class="form-label"><strong>Message Preview</strong></label>
              <div class="alert alert-success" id="bookingPreview"></div>
            </div>

            <!-- General Update Preview -->
            <div class="col-md-12 mb-3" id="generalUpdateDiv" style="display: none;">
              <label class="form-label"><strong>Message Preview</strong></label>
              <div class="alert alert-secondary" id="generalUpdatePreview"></div>
            </div>

            <div class="col-md-12">
              <button class="btn btn-primary" onclick="sendMessageToUser()" id="sendMessageBtn">
                <span id="sendMessageBtnText">Send Message</span>
              </button>
              <span id="messageStatus" class="ms-2"></span>
            </div>
          </div>
        </div>
      </div>

      <a href="/" class="btn btn-outline-secondary mt-4">‚Üê Back to Home</a>
    </div>

    <!-- Service Request Form Modal -->
    <div id="serviceRequestModal" class="modal fade" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">üìù Service Request Details</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="serviceRequestForm">
              <div class="row">
                <!-- Traveler Name -->
                <div class="col-md-6 mb-3">
                  <label class="form-label"><strong>Traveler Name *</strong></label>
                  <input type="text" class="form-control" id="travelerName" placeholder="Enter traveler name" required>
                </div>

                <!-- Country Code & Phone -->
                <div class="col-md-3 mb-3">
                  <label class="form-label"><strong>Country Code *</strong></label>
                  <input type="text" class="form-control" id="countryCode" placeholder="e.g., +91" value="+91" required>
                </div>

                <div class="col-md-3 mb-3">
                  <label class="form-label"><strong>Phone Number *</strong></label>
                  <input type="tel" class="form-control" id="travelerPhoneNumber" placeholder="Enter phone number"
                    required>
                </div>

                <!-- Traveler From (Location) -->
                <div class="col-md-6 mb-3">
                  <label class="form-label"><strong>Traveler From (Location) *</strong></label>
                  <input type="text" class="form-control" id="travelerFrom" placeholder="Enter location/country"
                    required>
                </div>

                <!-- Type of Monument to Visit -->
                <div class="col-md-6 mb-3">
                  <label class="form-label"><strong>Type of Monument to Visit *</strong></label>
                  <select class="form-control" id="monumentToVisit" onchange="handleMonumentChange()" required>
                    <option value="">Select a monument...</option>
                  </select>
                </div>

                <!-- Type of Service (loaded based on monument) -->
                <div class="col-md-6 mb-3">
                  <label class="form-label"><strong>Type of Service *</strong></label>
                  <select class="form-control" id="typeOfService" onchange="handleServiceChange()" required>
                    <option value="">Select a monument first...</option>
                  </select>
                </div>

                <!-- ‚úÖ Custom Service Input (shown only when "Other" is selected) -->
                <div class="col-md-6 mb-3" id="customServiceDiv" style="display: none;">
                  <label class="form-label"><strong>Specify Service *</strong></label>
                  <input type="text" class="form-control" id="customServiceInput"
                    placeholder="e.g., Water Bottle, Food, etc.">
                </div>

                <!-- Pickup Location -->
                <div class="col-md-6 mb-3">
                  <label class="form-label"><strong>Pickup Location *</strong></label>
                  <input type="text" class="form-control" id="pickupLocation" placeholder="Enter pickup location"
                    required>
                </div>

                <!-- Drop Location -->
                <div class="col-md-6 mb-3">
                  <label class="form-label"><strong>Drop Location *</strong></label>
                  <input type="text" class="form-control" id="dropLocation" placeholder="Enter drop location" required>
                </div>

                <!-- Date & Time -->
                <div class="col-md-6 mb-3">
                  <label class="form-label"><strong>Date of Travel *</strong></label>
                  <input type="date" class="form-control" id="dateOfTravel" required>
                </div>

                <!-- Time Slot Selection -->
                <div class="col-md-6 mb-3">
                  <label class="form-label"><strong>Time Slot *</strong></label>
                  <select class="form-control" id="timeSlotLabel" onchange="handleTimeSlotChange()" required>
                    <option value="">Select time slot...</option>
                    <option value="Morning">Morning (6:00 AM - 12:00 PM)</option>
                    <option value="Afternoon">Afternoon (12:00 PM - 6:00 PM)</option>
                    <option value="Evening">Evening (6:00 PM - 10:00 PM)</option>
                    <option value="Custom">Custom Time</option>
                  </select>
                </div>

                <!-- Custom Start Time (hidden by default) -->
                <div class="col-md-6 mb-3" id="customStartTimeDiv" style="display: none;">
                  <label class="form-label"><strong>Start Time *</strong></label>
                  <input type="time" class="form-control" id="customStartTime">
                </div>

                <!-- Custom End Time (hidden by default) -->
                <div class="col-md-6 mb-3" id="customEndTimeDiv" style="display: none;">
                  <label class="form-label"><strong>End Time *</strong></label>
                  <input type="time" class="form-control" id="customEndTime">
                </div>

                <!-- Number of Travelers -->
                <div class="col-md-6 mb-3">
                  <label class="form-label"><strong>Number of Travelers *</strong></label>
                  <input type="number" class="form-control" id="numberOfTravelers"
                    placeholder="Enter number of travelers" min="1" value="1" required>
                </div>

                <!-- Language Preference (from serviceLanguage collection) -->
                <div class="col-md-6 mb-3">
                  <label class="form-label"><strong>Language Preference *</strong></label>
                  <div id="languagePreferenceContainer">
                    <!-- Checkboxes will be loaded dynamically from serviceLanguage collection -->
                  </div>
                </div>

                <!-- Price -->
                <div class="col-md-6 mb-3">
                  <label class="form-label"><strong>Price</strong></label>
                  <input type="number" class="form-control" id="price" placeholder="Enter price" step="0.01">
                </div>

                <!-- Commission -->
                <div class="col-md-6 mb-3">
                  <label class="form-label"><strong>Commission</strong></label>
                  <input type="number" class="form-control" id="commission" placeholder="Enter commission" step="0.01">
                </div>

                <!-- Vendor Detail -->
                <div class="col-md-6 mb-3">
                  <label class="form-label"><strong>Vendor Detail</strong></label>
                  <input type="text" class="form-control" id="vendorDetail" placeholder="Enter vendor details">
                </div>

                <!-- Start OTP -->
                <div class="col-md-6 mb-3">
                  <label class="form-label"><strong>Start OTP</strong></label>
                  <input type="text" class="form-control" id="startOtp" placeholder="Enter start OTP">
                </div>

                <!-- End OTP -->
                <div class="col-md-6 mb-3">
                  <label class="form-label"><strong>End OTP</strong></label>
                  <input type="text" class="form-control" id="endOtp" placeholder="Enter end OTP">
                </div>

                <!-- Status -->
                <div class="col-md-6 mb-3">
                  <label class="form-label"><strong>Status</strong></label>
                  <select class="form-control" id="serviceStatus">
                    <option value="pending">Pending</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                  </select>
                </div>

                <!-- Payment Detail -->
                <div class="col-md-6 mb-3">
                  <label class="form-label"><strong>Payment Detail</strong></label>
                  <input type="text" class="form-control" id="paymentDetail" placeholder="Enter payment details">
                </div>

                <!-- Payment Status -->
                <div class="col-md-6 mb-3">
                  <label class="form-label"><strong>Payment Status</strong></label>
                  <select class="form-control" id="paymentStatus">
                    <option value="pending">Pending</option>
                    <option value="success">Success</option>
                    <option value="failed">Failed</option>
                  </select>
                </div>

                <!-- Description -->
                <div class="col-12 mb-3">
                  <label class="form-label"><strong>Description</strong></label>
                  <textarea class="form-control" id="description" rows="3"
                    placeholder="Enter any additional details"></textarea>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="submitServiceRequest()">
              <span id="submitBtnText">Submit & Update Status</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // API base URL
    const API_BASE = "/api";

    // Toggle between views
    function showListView() {
      document.getElementById("listView").classList.remove("hidden");
      document.getElementById("detailView").classList.add("hidden");
      loadMagicWordRequests();
    }

    function showDetailView() {
      document.getElementById("listView").classList.add("hidden");
      document.getElementById("detailView").classList.remove("hidden");
    }

    function getStatusBadgeClass(status) {
      switch (status) {
        case "requested":
          return "bg-warning";
        case "inProgress":
          return "bg-primary";
        case "completed":
          return "bg-success";
        default:
          return "bg-secondary";
      }
    }

    // Load all magic word requests
    async function loadMagicWordRequests() {
      try {
        const response = await fetch(`${API_BASE}/magic-words`);
        const data = await response.json();

        if (!data.found) {
          document.getElementById("emptyMessage").classList.remove("hidden");
          document.getElementById("requestsList").innerHTML = "";
          return;
        }

        document.getElementById("requestCount").textContent = data.count;
        const items = data.items || [];

        if (items.length === 0) {
          document.getElementById("emptyMessage").classList.remove("hidden");
          document.getElementById("requestsList").innerHTML = "";
          return;
        }

        document.getElementById("emptyMessage").classList.add("hidden");
        const html = items.map(item => {
          const matchedDate = new Date(item.matchedAt);
          const readableDate = matchedDate.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });

          return `
            <div class="col-md-6 col-lg-4">
              <div class="card magic-word-card" onclick="loadMagicWordDetail('${item.id}')">
                <div class="card-body">
                  <!-- Magic Word Badge -->
                  <h5 class="card-title">
                    <span class="badge bg-warning text-dark">${escapeHtml(item.magicWord)}</span>
                  </h5>
                  
                  <!-- Location & Timestamp -->
                  <p class="card-text text-muted small mb-2">
                    <strong>üìç Location:</strong> ${escapeHtml(item.location || "universal")}
                  </p>
                  <!-- Matched At -->
                  <p class="card-text text-muted small mb-2">
                    <strong>üìç MatchedAt:</strong> ${escapeHtml(readableDate || "unknown")}
                  </p>
                  <div class="d-flex justify-content-end">
                    <span class="badge ${getStatusBadgeClass(item.status)}">${item.status}</span>
                  </div>
                
                </div>
              </div>
            </div>
          `;
        }).join("");

        document.getElementById("requestsList").innerHTML = html;
      } catch (error) {
        console.error("Error loading requests:", error);
        alert("Error loading magic word requests");
      }
    }

    // Store current magic word ID and status for service request
    let currentMagicWordId = null;
    let currentStatus = null;

    // ‚úÖ Updated handleServiceChange with custom service logic
    function handleServiceChange() {
      const serviceSelect = document.getElementById("typeOfService");
      const selectedServiceValue = serviceSelect.value;
      const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
      const serviceId = selectedOption.dataset.serviceId;
      const serviceDescription = selectedOption.dataset.serviceDescription;

      console.log("üéØ Service selected:");
      console.log("   Title:", selectedServiceValue);
      console.log("   ID:", serviceId);
      console.log("   Description:", serviceDescription);

      // ‚úÖ Show custom service input if "Other" is selected
      const customServiceDiv = document.getElementById("customServiceDiv");
      const customServiceInput = document.getElementById("customServiceInput");

      if (selectedServiceValue.toLowerCase() === "other" || selectedServiceValue === "other") {
        customServiceDiv.style.display = "block";
        customServiceInput.required = true;
        console.log("‚úÖ Custom service input shown");
      } else {
        customServiceDiv.style.display = "none";
        customServiceInput.required = false;
        customServiceInput.value = "";
        console.log("‚úÖ Custom service input hidden");
      }
    }

    // ‚úÖ Load all monuments
    async function loadMonuments() {
      try {
        const response = await fetch(`${API_BASE}/monuments`);
        const data = await response.json();

        if (data.success && data.monuments) {
          const monumentSelect = document.getElementById("monumentToVisit");
          monumentSelect.innerHTML = '<option value="">Select a monument...</option>';

          data.monuments.forEach(monument => {
            const option = document.createElement("option");
            option.value = monument.id;
            option.textContent = monument.title || monument.name;
            option.dataset.monumentId = monument.id;
            monumentSelect.appendChild(option);
          });

          console.log("‚úÖ Monuments loaded:", data.monuments.length);
        }
      } catch (error) {
        console.error("Error loading monuments:", error);
      }
    }

    // ‚úÖ Load services based on selected monument
    async function loadServicesByMonument(monumentId) {
      try {
        if (!monumentId) {
          document.getElementById("typeOfService").innerHTML = '<option value="">Select a monument first...</option>';
          document.getElementById("typeOfService").disabled = true;
          return;
        }

        console.log("üîÑ Loading services for monument:", monumentId);

        const response = await fetch(`${API_BASE}/monuments/${monumentId}/services`);
        const data = await response.json();

        console.log("üì¶ Services response:", data);

        if (data.success && data.services && data.services.length > 0) {
          const serviceSelect = document.getElementById("typeOfService");
          serviceSelect.innerHTML = '<option value="">Select a service...</option>';
          serviceSelect.disabled = false;

          data.services.forEach(service => {
            const option = document.createElement("option");
            option.value = service.title || service.name || service.id;
            option.textContent = service.title || service.name || "Service";
            option.dataset.serviceId = service.id;
            option.dataset.serviceDescription = service.description || "";
            serviceSelect.appendChild(option);
            console.log("‚úÖ Added service:", option.textContent);
          });

          console.log("‚úÖ Services loaded:", data.services.length);
        } else {
          console.warn("‚ö†Ô∏è No available services for this monument");
          document.getElementById("typeOfService").innerHTML = '<option value="">No available services</option>';
          document.getElementById("typeOfService").disabled = true;
        }
      } catch (error) {
        console.error("‚ùå Error loading services:", error);
        document.getElementById("typeOfService").innerHTML = '<option value="">Error loading services</option>';
        document.getElementById("typeOfService").disabled = true;
      }
    }

    // ‚úÖ Handle monument change
    function handleMonumentChange() {
      const monumentSelect = document.getElementById("monumentToVisit");
      const selectedMonumentId = monumentSelect.value;

      console.log("üèõÔ∏è Monument selected:", selectedMonumentId);

      // Load services for selected monument
      if (selectedMonumentId) {
        loadServicesByMonument(selectedMonumentId);
      } else {
        document.getElementById("typeOfService").innerHTML = '<option value="">Select a monument first...</option>';
        document.getElementById("typeOfService").disabled = true;
      }
    }

    // Update changeStatus - remove loadServiceCategories() call
    async function changeStatus() {
      if (!currentMagicWordId) {
        alert("No magic word ID found");
        return;
      }

      try {
        console.log("üîç Fetching magic word detail for:", currentMagicWordId);

        const response = await fetch(`${API_BASE}/magic-words/${currentMagicWordId}`);
        const data = await response.json();

        console.log("üì¶ API Response:", data);

        if (!data.found) {
          alert("Error loading magic word details");
          return;
        }

        currentStatus = data.magic_word_request?.status || "requested";
        console.log("üìä Current Status:", currentStatus);

        if (currentStatus === "requested") {
          // Reset form first
          document.getElementById("serviceRequestForm").reset();

          // ‚úÖ Load monuments
          await loadMonuments();

          // ‚úÖ Load languages from serviceLanguage collection
          await loadLanguagePreferences();

          // ‚úÖ Pre-fill user information
          console.log("üë§ User data from API:", data.user);

          if (data.user) {
            const user = data.user;
            const firstName = user.firstName || "";
            const lastName = user.lastName || "";
            const fullName = `${firstName}`.trim();
            const phoneNumber = user.phoneNumber || "";

            console.log("üìù Pre-filling with:", {
              fullName: fullName,
              phoneNumber: phoneNumber
            });

            const travelerNameInput = document.getElementById("travelerName");
            if (fullName && travelerNameInput) {
              travelerNameInput.value = fullName;
              console.log("‚úÖ Traveler Name filled:", fullName);
            }

            const travelerPhoneInput = document.getElementById("travelerPhoneNumber");
            if (phoneNumber && travelerPhoneInput) {
              travelerPhoneInput.value = phoneNumber;
              console.log("‚úÖ Traveler Phone filled:", phoneNumber);
            }

            const countryCodeInput = document.getElementById("countryCode");
            if (countryCodeInput) {
              countryCodeInput.value = "+91";
            }
          }

          // ‚úÖ Display chat history
          if (data.chat_history && data.chat_history.length > 0) {
            console.log("üí¨ Chat history loaded:", data.chat_history.length, "messages");
            // displayChatHistory(data.chat_history);
          }

          // Show modal
          const modal = new bootstrap.Modal(document.getElementById("serviceRequestModal"));
          modal.show();
          console.log("üé¨ Modal opened");

        } else if (currentStatus === "inProgress") {
          console.log("‚è≥ Status is inProgress, changing to completed...");
          await updateMagicWordStatus();
        }
      } catch (error) {
        console.error("‚ùå Error:", error);
        alert("Error: " + error.message);
      }
    }

    // ‚úÖ Load languages from serviceLanguage collection
    async function loadLanguagePreferences() {
      try {
        const response = await fetch(`${API_BASE}/service-languages`);
        const data = await response.json();

        console.log("üìö Languages loaded:", data);

        if (data.success && data.languages) {
          const container = document.getElementById("languagePreferenceContainer");
          container.innerHTML = "";

          data.languages.forEach(lang => {
            const div = document.createElement("div");
            div.className = "form-check";
            div.innerHTML = `
              <input class="form-check-input language-checkbox" type="checkbox" id="lang_${lang.id}" value="${lang.title || lang.name}">
              <label class="form-check-label" for="lang_${lang.id}">
                ${lang.title || lang.name}
              </label>
            `;
            container.appendChild(div);
          });

          console.log("‚úÖ Language preferences loaded");
        }
      } catch (error) {
        console.error("Error loading language preferences:", error);
      }
    }

    // ‚úÖ Updated submitServiceRequest with custom service support
    async function submitServiceRequest() {
      // Validate required fields
      const requiredFields = ["travelerName", "countryCode", "travelerPhoneNumber", "travelerFrom", "monumentToVisit", "typeOfService", "pickupLocation", "dropLocation", "dateOfTravel", "timeSlotLabel", "numberOfTravelers"];
      for (let field of requiredFields) {
        if (!document.getElementById(field).value) {
          alert(`Please fill in all required fields`);
          return;
        }
      }

      try {
        // ‚úÖ Get time slot details with validation
        const timeSlot = getTimeSlotDetails();

        // ‚úÖ Get service ID instead of title
        const serviceSelect = document.getElementById("typeOfService");
        const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
        // let serviceId = selectedOption.dataset.serviceId;
        // let serviceName = selectedOption.value;

        // ‚úÖ Check if "Other" service with custom input
        const customServiceDiv = document.getElementById("customServiceDiv");
        const customServiceInput = document.getElementById("customServiceInput");

        let serviceId = selectedOption.dataset.serviceId || "";
        let serviceName = selectedOption.value || "";
        let otherSpecify = null;

        if (customServiceDiv.style.display !== "none") {
          const val = customServiceInput.value.trim();
          if (!val) {
            alert("Please specify the service type");
            return;
          }

          serviceId = "other";          // ‚úÖ keep old behavior
          serviceName = "Other";        // optional
          otherSpecify = val;           // ‚úÖ new field
          console.log("‚úÖ Custom service:", serviceName, "Specify:", otherSpecify);
        }


        // if (customServiceDiv.style.display !== "none") {
        //   if (!customServiceInput.value.trim()) {
        //     alert("Please specify the service type");
        //     return;
        //   }
        //   serviceName = customServiceInput.value.trim();
        //   serviceId = "custom_" + Date.now();
        //   console.log("‚úÖ Custom service:", serviceName);
        // }

        // ‚úÖ Get selected language preferences (multiple checkboxes)
        const languagePreferences = [];
        document.querySelectorAll('input.language-checkbox:checked').forEach(checkbox => {
          languagePreferences.push(checkbox.value);
        });

        if (languagePreferences.length === 0) {
          alert("Please select at least one language preference");
          return;
        }

        // Collect form data
        const serviceDetails = {
          // ‚úÖ Traveler Information
          travelerName: document.getElementById("travelerName").value.trim(),
          countryCode: document.getElementById("countryCode").value.trim(),
          travelerPhoneNumber: `${document.getElementById("countryCode").value.trim()} ${document.getElementById("travelerPhoneNumber").value.trim()}`,
          travelerFrom: document.getElementById("travelerFrom").value.trim(),

          // ‚úÖ Monument and Service
          monumentToVisit: document.getElementById("monumentToVisit").value.trim(),
          typeOfService: serviceId,
          serviceName: serviceName,
          ...(otherSpecify ? { otherSpecify } : {}),

          // ‚úÖ Date & Time Slot
          dateOfTravel: document.getElementById("dateOfTravel").value,
          timeSlot: timeSlot,

          // ‚úÖ Guide Details
          numberOfTravelers: parseInt(document.getElementById("numberOfTravelers").value) || 1,
          languagePreference: languagePreferences,

          // Service Details
          pickupLocation: document.getElementById("pickupLocation").value,
          dropLocation: document.getElementById("dropLocation").value,
          price: document.getElementById("price").value || "0",
          commission: document.getElementById("commission").value || "0",
          vendorDetail: document.getElementById("vendorDetail").value || "",
          startOtp: document.getElementById("startOtp").value || "",
          endOtp: document.getElementById("endOtp").value || "",
          status: document.getElementById("serviceStatus").value,
          paymentDetail: document.getElementById("paymentDetail").value || "",
          paymentStatus: document.getElementById("paymentStatus").value,
          description: document.getElementById("description").value || "",
        };

        console.log("üì§ Sending data:", serviceDetails);

        const submitBtn = document.querySelector('[onclick="submitServiceRequest()"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';

        const response = await fetch(`${API_BASE}/magic-words/${currentMagicWordId}/status`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            bookingType: serviceDetails.typeOfService,
            details: serviceDetails
          })
        });

        const result = await response.json();

        if (result.success) {
          const modal = bootstrap.Modal.getInstance(document.getElementById("serviceRequestModal"));
          modal.hide();

          const statusElement = document.getElementById("detail-status");
          statusElement.textContent = result.new_status;
          updateStatusBadgeColor(result.new_status);
          updateStatusButtonText(result.new_status);

          alert("‚úÖ Service request submitted successfully!");

          setTimeout(() => {
            loadMagicWordRequests();
          }, 1500);
        } else {
          alert(`‚ùå Error: ${result.error}`);
        }
      } catch (error) {
        console.error("Error submitting service request:", error);
        alert(`‚ùå ${error.message || "Error submitting service request"}`);
      } finally {
        const submitBtn = document.querySelector('[onclick="submitServiceRequest()"]');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Submit & Update Status';
      }
    }

    // Update magic word status
    async function updateMagicWordStatus() {
      try {
        const response = await fetch(`${API_BASE}/magic-words/${currentMagicWordId}/status`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({})
        });

        const result = await response.json();

        if (result.success) {
          const statusElement = document.getElementById("detail-status");
          statusElement.textContent = result.new_status;
          updateStatusBadgeColor(result.new_status);
          updateStatusButtonText(result.new_status);

          alert("‚úÖ Status updated successfully!");

          setTimeout(() => {
            loadMagicWordRequests();
          }, 1500);
        } else {
          alert(`‚ùå Error: ${result.error}`);
        }
      } catch (error) {
        console.error("Error updating status:", error);
        alert("Error updating status");
      }
    }

    // Update badge color based on status
    function updateStatusBadgeColor(statusValue) {
      const statusElement = document.getElementById("detail-status");
      statusElement.classList.remove("bg-warning", "bg-success", "bg-danger", "bg-info", "bg-primary");

      if (statusValue === "requested") {
        statusElement.classList.add("bg-warning", "text-dark");
      } else if (statusValue === "completed") {
        statusElement.classList.add("bg-success");
      } else if (statusValue === "inProgress") {
        statusElement.classList.add("bg-primary");
      } else {
        statusElement.classList.add("bg-info");
      }
    }

    // Update button text based on current status
    function updateStatusButtonText(statusValue) {
      const btn = document.getElementById("statusChangeBtn");

      if (statusValue === "requested") {
        btn.textContent = "Mark as In Progress";
      } else if (statusValue === "inProgress") {
        btn.textContent = "Mark as Completed";
      } else if (statusValue === "completed") {
        btn.textContent = "Status Complete";
        btn.disabled = true;
      }
    }

    // Load detail for a specific magic word request
    async function loadMagicWordDetail(id) {
      try {
        currentMagicWordId = id;  // ‚úÖ Store ID for status change

        const response = await fetch(`${API_BASE}/magic-words/${id}`);
        const data = await response.json();

        if (!data.found) {
          alert("Error loading details");
          return;
        }

        const magic = data.magic_word_request || {};
        const chat = data.chat || {};
        const user = data.user || {};
        const location = data.user_location || {};
        const chatHistory = data.chat_history || [];

        // Fill magic word request info
        document.getElementById("detail-magicWord").textContent = magic.magicWord || "N/A";

        // Set status with appropriate badge color
        const statusElement = document.getElementById("detail-status");
        const statusValue = magic.status || "N/A";
        statusElement.textContent = statusValue;
        updateStatusBadgeColor(statusValue);
        updateStatusButtonText(statusValue);  // ‚úÖ Update button text

        document.getElementById("detail-matchedAt").textContent = magic.matchedAt_readable || magic.matchedAt || "N/A";
        document.getElementById("detail-chatId").textContent = chat.id || "N/A";
        document.getElementById("detail-messageId").textContent = magic.messageId || "N/A";
        document.getElementById("detail-location").textContent = chat.location || "N/A";

        // Fill chat context (last 10 messages) INSTEAD of single user/assistant messages
        if (chatHistory && chatHistory.length > 0) {
          document.getElementById("noChatContextMessage").classList.add("hidden");
          const chatContextHtml = chatHistory.map(msg => {
            const role = msg.role || "unknown";
            const icon = role === "user" ? "üë§" : role === "assistant" ? "ü§ñ" : "üí¨";
            const bgColor = role === "user" ? "#e7f3ff" : role === "assistant" ? "#e8f5e9" : "#f5f5f5";
            const timestamp = msg.created_at_readable || msg.created_at || "";

            return `
              <div class="mb-2 p-2 rounded" style="background-color: ${bgColor}; border-left: 4px solid ${role === "user" ? "#2196F3" : role === "assistant" ? "#4CAF50" : "#999"};">
                <div class="d-flex justify-content-between align-items-start">
                  <strong style="font-size: 0.9rem;">${icon} ${role.toUpperCase()}</strong>
                  <small class="text-muted" style="font-size: 0.75rem;">${escapeHtml(timestamp)}</small>
                </div>
                <p class="mb-0 mt-1" style="word-break: break-word; font-size: 0.9rem;">${escapeHtml(msg.content || "")}</p>
              </div>
            `;
          }).join("");
          document.getElementById("detail-chatContext").innerHTML = chatContextHtml;
        } else {
          document.getElementById("noChatContextMessage").classList.remove("hidden");
          document.getElementById("detail-chatContext").innerHTML = "";
        }

        // Fill user info
        document.getElementById("detail-userId").textContent = user.id || "N/A";
        document.getElementById("detail-userName").textContent = `${user.firstName || ""} ${user.lastName || ""}`.trim() || "N/A";
        document.getElementById("detail-userEmail").textContent = user.email || "N/A";
        document.getElementById("detail-userPhone").textContent = user.phoneNumber || "N/A";

        if (user.photoURL) {
          document.getElementById("detail-userPhoto").src = user.photoURL;
          document.getElementById("detail-userPhoto").style.display = "block";
        } else {
          document.getElementById("detail-userPhoto").style.display = "none";
        }

        // Fill location info
        document.getElementById("detail-locName").textContent = location.location || "N/A";
        document.getElementById("detail-locLat").textContent = location.latitude || "N/A";
        document.getElementById("detail-locLon").textContent = location.longitude || "N/A";
        document.getElementById("detail-locRecordedAt").textContent = location.created_at_readable || location.created_at || "N/A";

        // Create map link
        if (location.latitude && location.longitude) {
          const mapUrl = `https://maps.google.com/?q=${location.latitude},${location.longitude}`;
          document.getElementById("detail-mapLink").href = mapUrl;
        }

        showDetailView();
      } catch (error) {
        console.error("Error loading detail:", error);
        alert("Error loading magic word detail");
      }
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    // Back button
    document.getElementById("backBtn").addEventListener("click", showListView);

    // Load list on page load
    document.addEventListener("DOMContentLoaded", showListView);

    // ‚úÖ Handle time slot change
    function handleTimeSlotChange() {
      const timeSlotLabel = document.getElementById("timeSlotLabel").value;
      const customStartTimeDiv = document.getElementById("customStartTimeDiv");
      const customEndTimeDiv = document.getElementById("customEndTimeDiv");
      const customStartTime = document.getElementById("customStartTime");
      const customEndTime = document.getElementById("customEndTime");

      console.log("‚è∞ Time slot selected:", timeSlotLabel);

      if (timeSlotLabel === "Custom") {
        // Show custom time inputs
        customStartTimeDiv.style.display = "block";
        customEndTimeDiv.style.display = "block";
        customStartTime.required = true;
        customEndTime.required = true;
        console.log("‚úÖ Custom time inputs shown");
      } else {
        // Hide custom time inputs
        customStartTimeDiv.style.display = "none";
        customEndTimeDiv.style.display = "none";
        customStartTime.required = false;
        customEndTime.required = false;
        customStartTime.value = "";
        customEndTime.value = "";
        console.log("‚úÖ Custom time inputs hidden");
      }
    }

    // ‚úÖ Get time slot details
    function getTimeSlotDetails() {
      const timeSlotLabel = document.getElementById("timeSlotLabel").value;

      const timeSlots = {
        "Morning": { startTime: "06:00", endTime: "12:00" },
        "Afternoon": { startTime: "12:00", endTime: "18:00" },
        "Evening": { startTime: "18:00", endTime: "22:00" },
      };

      if (timeSlotLabel === "Custom") {
        // Get custom times
        const startTime = document.getElementById("customStartTime").value;
        const endTime = document.getElementById("customEndTime").value;

        if (!startTime || !endTime) {
          alert("Please enter both start and end times for custom slot");
          throw new Error("Missing custom time values");
        }

        console.log("‚è∞ Custom time slot:", { startTime, endTime });
        return {
          label: "Custom",
          startTime: startTime,
          endTime: endTime
        };
      } else if (timeSlots[timeSlotLabel]) {
        // Get predefined times
        const times = timeSlots[timeSlotLabel];
        console.log("‚è∞ Predefined time slot:", { label: timeSlotLabel, ...times });
        return {
          label: timeSlotLabel,
          startTime: times.startTime,
          endTime: times.endTime
        };
      } else {
        alert("Please select a valid time slot");
        throw new Error("Invalid time slot");
      }
    }

    // Handle message type change
    function handleMessageTypeChange() {
      const messageType = document.getElementById("messageType").value;
      const customMessageDiv = document.getElementById("customMessageDiv");
      const serviceRequestPreviewDiv = document.getElementById("serviceRequestPreviewDiv");
      const bookingPreviewDiv = document.getElementById("bookingPreviewDiv");
      const generalUpdateDiv = document.getElementById("generalUpdateDiv");

      // Hide all preview divs
      serviceRequestPreviewDiv.style.display = "none";
      bookingPreviewDiv.style.display = "none";
      generalUpdateDiv.style.display = "none";

      if (messageType === "custom") {
        // Show custom message input
        customMessageDiv.style.display = "block";
        customMessageDiv.required = true;
      } else {
        customMessageDiv.style.display = "none";
        customMessageDiv.required = false;
        document.getElementById("customMessage").value = ""; // Clear custom message
      }

      // Show preview based on message type
      if (messageType === "service_request") {
        serviceRequestPreviewDiv.style.display = "block";
        document.getElementById("serviceRequestPreview").textContent = `Service Request Details:
        - Traveler: John Doe
        - Date: 2023-10-10
        - Time: 10:00 AM - 12:00 PM
        - Pickup: Hotel
        - Drop: Airport`;
      } else if (messageType === "booking_confirmation") {
        bookingPreviewDiv.style.display = "block";
        document.getElementById("bookingPreview").textContent = `Booking Confirmation:
        - Confirmation Number: ABC123456
        - Status: Confirmed
        - Date: 2023-10-10
        - Time: 10:00 AM - 12:00 PM`;
      } else if (messageType === "general") {
        generalUpdateDiv.style.display = "block";
        document.getElementById("generalUpdatePreview").textContent = `General Update:
        - Your request is being processed.
        - Expected response time: 24 hours`;
      }
    }

    // ‚úÖ Helper function to escape special characters for JSON
    function escapeJsonString(str) {
      if (!str) return "";
      return str
        .replace(/\\/g, "\\\\")
        .replace(/"/g, '\\"')
        .replace(/\n/g, "\\n")
        .replace(/\r/g, "\\r")
        .replace(/\t/g, "\\t");
    }

    // ‚úÖ Send message to user
    async function sendMessageToUser() {
      const messageType = document.getElementById("messageType").value;
      
      if (!messageType) {
        alert("Please select a message type");
        return;
      }

      if (!currentMagicWordId) {
        alert("No magic word ID found");
        return;
      }

      let messageContent = "";

      if (messageType === "custom") {
        messageContent = document.getElementById("customMessage").value.trim();
        if (!messageContent) {
          alert("Please enter a message");
          return;
        }
      } else if (messageType === "service_request") {
        const serviceName = "Service";
        messageContent = `‚úÖ Your request has been created\n\nüßæ Service: ${serviceName}\n\nOur team will contact you shortly.\n\nWe've logged your request, and it's all set on our end.\n\nTo move ahead, just follow these quick steps in the app:\n\nüë§ Profile ‚Üí üõí Cart ‚Üí üëú My Order\n\nüë§ Profile ‚Äì check or update your details\n\nüõí Cart ‚Äì place your order\n\nüëú My Order ‚Äì track the status once your order is placed\n\nOur team will take it from here and keep you updated. If you need any help, just let me know üôÇ`;
      } else if (messageType === "booking_confirmation") {
        messageContent = `üé´ Booking Confirmed!\n\nüìã Service Type: [Service Type]\nüìã Service: [Service Name]\nüí∞ Total Amount: ‚Çπ[Amount]\nüìÖ Date: [Date]\nüïê Time Slot: [Time]\n\nYour booking has been confirmed! Thank you for choosing our service.`;
      } else if (messageType === "general") {
        messageContent = `üì¢ Update\n\nWe're here to help! If you have any questions about your booking or need any assistance, please let us know.\n\nOur team is available to support you throughout your journey.`;
      }

      try {
        const sendBtn = document.getElementById("sendMessageBtn");
        sendBtn.disabled = true;
        document.getElementById("sendMessageBtnText").innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';

        // ‚úÖ Get chat ID from the detail section
        const chatIdElement = document.getElementById("detail-chatId");
        const chatId = chatIdElement ? chatIdElement.textContent.trim() : "";
        
        if (!chatId) {
          alert("Chat ID not found. Please reload the detail view.");
          sendBtn.disabled = false;
          document.getElementById("sendMessageBtnText").textContent = "Send Message";
          return;
        }

        // ‚úÖ Create proper JSON payload
        const payload = {
          messageType: messageType,
          message: messageContent,
          chatId: chatId
        };

        console.log("üì® Sending payload:", payload);

        const response = await fetch(`/api/magic-words/${currentMagicWordId}/send-message`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        // ‚úÖ Check if response is JSON
        const contentType = response.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
          const text = await response.text();
          console.error("‚ùå Non-JSON response:", text);
          throw new Error(`Server returned ${response.status}: ${text.substring(0, 100)}`);
        }

        const result = await response.json();

        if (result.success) {
          alert("‚úÖ Message sent successfully!");
          document.getElementById("messageType").value = "";
          document.getElementById("customMessage").value = "";
          document.getElementById("customMessageDiv").style.display = "none";
          document.getElementById("messageStatus").innerHTML = '<span class="badge bg-success">Message sent!</span>';
          
          setTimeout(() => {
            document.getElementById("messageStatus").innerHTML = "";
          }, 3000);
        } else {
          alert(`‚ùå Error: ${result.error}`);
        }
      } catch (error) {
        console.error("‚ùå Error sending message:", error);
        alert(`‚ùå ${error.message || "Error sending message"}`);
      } finally {
        const sendBtn = document.getElementById("sendMessageBtn");
        sendBtn.disabled = false;
        document.getElementById("sendMessageBtnText").textContent = "Send Message";
      }
    }

    // Toggle human interaction mode
    function toggleHumanInteraction() {
      const toggle = document.getElementById("humanInteractionToggle");
      const statusLabel = document.getElementById("toggleLabel");
      const statusBadge = document.getElementById("toggleStatus");

      if (toggle.checked) {
        statusLabel.textContent = "kabirTeam";
        statusBadge.className = "badge bg-success";
        statusBadge.textContent = "Active";
        console.log("üîÑ Switched to kabirTeam mode");
      } else {
        statusLabel.textContent = "kabirAI";
        statusBadge.className = "badge bg-secondary";
        statusBadge.textContent = "Active";
        console.log("üîÑ Switched to kabirAI mode");
      }
    }
  </script>
</body>

</html>